// Module included in the following assemblies:
//
// * install_config/configuring_for_vsphere.adoc

[[vsphere-prereqs]]
=== VMware vSphere cloud provider prerequisites

vSphere

* vSphere version - 6.0.x (Virtual Hardware 11) and above. (*Note:* Standalone ESX is not supported.)
* vSAN, VMFS and NFS supported.
** vSAN support is limited to one cluster in one vCenter.

=== Prerequisites

VMware vSphere requires installation of the VMware Tools on each Node VM.
See
link:https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.html.hostclient.doc/GUID-ED3ECA21-5763-4919-8947-A819A17980FB.html[Installing VMware tools] for more information.

The link:https://github.com/vmware/govmomi/tree/master/govc#govc[govc] CLI can be used for additional configuration and troubleshooting. Example govc configuration:
----
    export GOVC_URL='vCenter IP OR FQDN'
    export GOVC_USERNAME='vCenter User'
    export GOVC_PASSWORD='vCenter Password'
    export GOVC_INSECURE=1
----

=== Permissions

Create and assign roles to the vSphere Cloud Provider. 

A vCenter user with required set of link:https://vmware.github.io/vsphere-storage-for-kubernetes/documentation/vcp-roles.html[privileges] is required. 

In general, vSphere user designated for vSphere Cloud Provider should have *Read access* on parent entities of the node Virtual Machines such as folder, host, datacenter etc. * VirtualMachine.Inventory.Create/Delete on the defined resource pool. Used to create/delete dummy VMs.

See the link:https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.security.doc/GUID-18071E9A-EED1-4968-8D51-E0B4F526FDA3.html[vSphere
Documentation Center] for steps to create a custom role, user, and role
assignment.

vSphere Cloud Provider supports OpenShift clusters spanning across multiple vCenters. Make sure that all above privileges are correctly set for all vCenters.

=== Minimal set of vSphere roles/privileges required for dynamic persistent volume provisioning with storage policy based volume placement.

*Note:* dynamic persistent volume creation is the recommended practice.

[cols=4*,width="100%",options=header]
|===
|Roles
|Privileges
|Entities
|Propergate to Children

|manage-k8s-node-vms
|Resource.AssignVMToPool, VirtualMachine.Config.AddExistingDisk, VirtualMachine.Config.AddNewDisk, VirtualMachine.Config.AddRemoveDevice, VirtualMachine.Config.RemoveDisk, VirtualMachine.Inventory.Create, VirtualMachine.Inventory.Delete, VirtualMachine.Config.Settings
|Cluster, Hosts, VM Folder
|Yes

|manage-k8s-volumes
|Datastore.AllocateSpace, Datastore.FileManagement (Low level file operations)
|Datastore
|No

|k8s-system-read-and-spbm-profile-view
|StorageProfile.View (Profile-driven storage view)
|vCenter
|No

|Read-only (pre-existing default role)
|System.Anonymous, System.Read, System.View
|Datacenter, Datastore Cluster, Datastore Storage Folder
|No

|===

=== Minimal set of vSphere roles/privileges required for dynamic persistent volume provisioning *without* storage policy based volume placement.

*Note:* dynamic persistent volume creation is the recommended practice.

[cols=4*,width="100%",options=header]
|===
|Roles
|Privileges
|Entities
|Propergate to Children

|manage-k8s-node-vms
|Resource.AssignVMToPool, VirtualMachine.Config.AddExistingDisk, VirtualMachine.Config.AddNewDisk, VirtualMachine.Config.AddRemoveDevice, VirtualMachine.Config.RemoveDisk
|VM Folder
|Yes

|manage-k8s-volumes
|Datastore.AllocateSpace, Datastore.FileManagement (Low level file operations)
|Datastore
|No

|Read-only (pre-existing default role)
|System.Anonymous, System.Read, System.View
|vCenter, Datacenter, Datastore Cluster, Datastore Storage Folder, Cluster, Hosts
|No


|===

=== Minimal set of vSphere roles/privileges required for static only persistent volume provisioning.
*Note:* Datastore.FileManagement is only required for the role manage-k8s-volumes, if PVC is created to bind with statically provisioned PV, and reclaim policy set to delete. When PVC is deleted, associated statically provisioned PV will also be deleted.

[cols=4*,width="100%",options=header]
|===
|Roles
|Privileges
|Entities
|Propergate to Children

|manage-k8s-node-vms
|VirtualMachine.Config.AddExistingDisk, VirtualMachine.Config.AddNewDisk, VirtualMachine.Config.AddRemoveDevice, VirtualMachine.Config.RemoveDisk
|VM Folder
|Yes

|manage-k8s-volumes
|Datastore.FileManagement (Low level file operations)
|Datastore
|No

|Read-only (pre-existing default role)
|System.Anonymous, System.Read, System.View
|vCenter, Datacenter, Datastore Cluster, Datastore Storage Folder, Cluster, Hosts
|No
...
|===



.Procedure

. Create link:https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.vcenterhost.doc/GUID-031BDB12-D3B2-4E2D-80E6-604F304B4D0C.html[a
VM folder] and move {product-title} Node VMs to this folder.

. Verify that the Node VM names complies with the regex `[a-z](([-0-9a-z]+)?[0-9a-z])?(\.[a-z0-9](([-0-9a-z]+)?[0-9a-z])?)*`.
+
[IMPORTANT]
====
VM Names cannot:

* Begin with numbers.
* Have any capital letters.
* Have any special characters except `-`.
* Be shorter than three characters and longer than 63 characters.
====

. Set the `disk.EnableUUID` parameter to `true` for each Node VM. This ensures that the VMware vSphere's Virtual Machine Disk (VMDK) always presents a consistent UUID to the VM, allowing the disk to be mounted properly.
+
For every  VM node that will be participating in the cluster should have `disk.EnableUUID` parameter set to `true` follow either of the  steps below using the vSphere console or GOVC CLI tool:

+
.. From the vSphere HTML Client navigate to *VM properties* -> *VM Options* -> *Advanced* -> *Configuration* *Parameters* -> *disk.enableUUID=TRUE*
+
.. Or using ehe govc CLI, find the Node VM paths:
+
[source,bash]
----
govc ls /datacenter/vm/<vm-folder-name>
----

.. Set `disk.EnableUUID` to `true` for all VMs:
+
[source,bash]
----
govc vm.change -e="disk.enableUUID=1" -vm='VM Path'
----

[NOTE]
====
If {product-title} node VMs are created from a virtual machine template, then
`disk.EnableUUID=1` can be set on the template VM. VMs cloned from this
template inherit this property.
====

. 
+
[cols="4*", width="100%",options="header"]
|===
|Roles
|Privileges
|Entities
|Propagate to Children

|manage-k8s-node-vms
|Resource.AssignVMToPool
System.Anonymous
System.Read
System.View
VirtualMachine.Config.AddExistingDisk
VirtualMachine.Config.AddNewDisk
VirtualMachine.Config.AddRemoveDevice
VirtualMachine.Config.RemoveDisk
VirtualMachine.Inventory.Create
VirtualMachine.Inventory.Delete
|Cluster,
Hosts,
VM Folder
|Yes

|manage-k8s-volumes
|Datastore.AllocateSpace
Datastore.FileManagement
System.Anonymous
System.Read
System.View
|Datastore
|No

|k8s-system-read-and-spbm-profile-view
|StorageProfile.View
System.Anonymous
System.Read
System.View
|vCenter
|No

|ReadOnly
|System.Anonymous
System.Read
System.View
|Datacenter,
Datastore Cluster,
Datastore Storage Folder
|No

|===


